
import pandas as pd

# Load processed data
train_df = pd.read_csv('/mnt/d/PythonProjects/AutoKaggleMaster/multi_agents/competition/plate_defect/processed_train.csv')
test_df = pd.read_csv('/mnt/d/PythonProjects/AutoKaggleMaster/multi_agents/competition/plate_defect/processed_test.csv')

# Define target columns
target_columns = ['Pastry', 'Z_Scratch', 'K_Scatch', 'Stains', 'Dirtiness', 'Bumps', 'Other_Faults']

# Separate features and target variables
y_train = train_df[target_columns]
X_train = train_df.drop(columns=['id'] + target_columns)

# For test data, drop 'id' column and ensure consistency with training data
X_test = test_df.drop(columns=['id'])

# Ensure columns in test set match those in training set
assert list(X_train.columns) == list(X_test.columns), "Mismatch in training and test columns"

print("Data preparation completed: X_train and y_train are ready for model training.")


from sklearn.multioutput import MultiOutputClassifier
from sklearn.ensemble import RandomForestClassifier

# Define the base model
base_model = RandomForestClassifier()

# Wrap the base model with MultiOutputClassifier for multilabel classification
multi_target_model = MultiOutputClassifier(base_model, n_jobs=-1)

# Train the model
multi_target_model.fit(X_train, y_train)

print("Model training and validation completed. Best model selected.")


# No additional code needed for this step as the model selection is handled by using MultiOutputClassifier
print("Model validation and selection are handled within the MultiOutputClassifier.")


# Predict probabilities for each defect category using the best model
predictions = multi_target_model.predict_proba(X_test)

# Aggregate the predictions into a DataFrame with columns for each class probability
predictions_dict = {}
for i, target in enumerate(target_columns):
    # Assuming binary classification (class 0 and class 1)
    class_1_probabilities = predictions[i][:, 1]
    predictions_dict[target] = class_1_probabilities

# Create the DataFrame from the dictionary
predictions_df = pd.DataFrame(predictions_dict)

# Ensure the columns are in the correct order as in sample_submission.csv
expected_columns = ['id'] + target_columns

# Create a submission DataFrame
submission_df = pd.DataFrame(test_df['id'], columns=['id'])
submission_df = pd.concat([submission_df, predictions_df], axis=1)
submission_df = submission_df[expected_columns]

# Save the submission DataFrame
submission_file = '/mnt/d/PythonProjects/AutoKaggleMaster/multi_agents/competition/plate_defect/submission.csv'
submission_df.to_csv(submission_file, index=False)

print(f"Predictions saved to {submission_file}")
